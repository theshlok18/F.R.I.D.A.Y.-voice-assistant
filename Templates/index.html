<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>F.R.I.D.A.Y. | STARK INDUSTRIES</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

        :root {
            --primary: #00f0ff;
            --secondary: #0088ff;
            --alert: #ff3333;
            --bg-dim: rgba(0, 10, 20, 0.6);
            --glass: rgba(0, 240, 255, 0.05);
        }

        body { 
            margin: 0; 
            background: #000; 
            color: var(--primary); 
            font-family: 'Share Tech Mono', monospace; 
            overflow: hidden; 
            height: 100vh;
            text-transform: uppercase;
        }

        /* --- VIDEO BACKGROUND --- */
        #video-layer { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            z-index: -1;
            filter: brightness(0.6) contrast(1.2) hue-rotate(180deg) saturate(0.5); 
        }

        /* --- HUD CONTAINER --- */
        .hud-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at center, transparent 50%, rgba(0,0,0,0.8) 100%),
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            pointer-events: none;
        }

        /* --- DECORATIVE CORNERS --- */
        .corner { position: absolute; width: 150px; height: 150px; border: 2px solid var(--primary); opacity: 0.8; transition: 0.5s; }
        .top-left { top: 20px; left: 20px; border-right: none; border-bottom: none; border-top-left-radius: 10px; }
        .top-right { top: 20px; right: 20px; border-left: none; border-bottom: none; border-top-right-radius: 10px; }
        .bottom-left { bottom: 20px; left: 20px; border-right: none; border-top: none; border-bottom-left-radius: 10px; }
        .bottom-right { bottom: 20px; right: 20px; border-left: none; border-top: none; border-bottom-right-radius: 10px; }

        /* --- HEADER --- */
        .header-bar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; align-items: center;
        }
        .header-item {
            background: var(--glass); border: 1px solid var(--primary);
            padding: 5px 15px; font-size: 12px; letter-spacing: 2px;
            box-shadow: 0 0 10px var(--primary);
        }

        /* --- LEFT COLUMN (STATS) --- */
        .left-col {
            position: absolute; left: 40px; top: 200px; bottom: 200px;
            width: 200px; display: flex; flex-direction: column; gap: 15px;
        }
        .stat-box { border-left: 3px solid var(--primary); padding-left: 10px; background: linear-gradient(90deg, var(--glass), transparent); }
        .stat-label { font-size: 10px; opacity: 0.7; }
        .stat-bar { height: 4px; background: #333; margin-top: 5px; width: 100%; position: relative; }
        .stat-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; box-shadow: 0 0 5px var(--primary); }

        /* --- RIGHT COLUMN (LOGS) --- */
        .right-col {
            position: absolute; right: 40px; top: 150px; bottom: 150px;
            width: 250px; text-align: right;
            font-size: 10px; line-height: 1.4;
            overflow: hidden; opacity: 0.8;
        }
        .log-entry { color: var(--secondary); margin-bottom: 2px; text-shadow: 0 0 2px var(--secondary); }
        .highlight { color: #fff; font-weight: bold; }

        /* --- F.R.I.D.A.Y. VOICE VISUALIZER --- */
        .voice-hud {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            text-align: center;
        }
        .arc-reactor {
            width: 80px; height: 80px;
            position: relative; margin: 0 auto 10px;
            display: flex; justify-content: center; align-items: center;
        }
        .ring {
            position: absolute; border-radius: 50%; border: 2px solid var(--primary);
            box-shadow: 0 0 10px var(--primary); opacity: 0.5;
        }
        /* REPLACED THE SPINNING RECTANGLES WITH STATIC SCI-FI RINGS */
        .r1 { width: 100%; height: 100%; border: 1px dashed var(--primary); }
        .r2 { width: 70%; height: 70%; border: 1px solid var(--primary); }
        .r3 { width: 40%; height: 40%; background: var(--primary); box-shadow: 0 0 20px var(--primary); }
        
        .speaking .r3 { animation: pulse 0.2s infinite alternate; background: #fff; }
        .speaking .ring { border-color: #fff; box-shadow: 0 0 20px #fff; }

        #subtitle { font-family: 'Orbitron'; font-size: 14px; letter-spacing: 3px; background: #000; padding: 2px 10px; }

        /* --- RESULT BOX --- */
        .scan-window {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0);
            width: 400px; background: rgba(0, 15, 30, 0.9);
            border: 1px solid var(--primary);
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.2);
            transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            backdrop-filter: blur(5px);
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
        }
        .scan-window.active { transform: translate(-50%, -50%) scale(1); }
        .scan-header { background: var(--glass); padding: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--primary); }
        .scan-body { padding: 20px; text-align: center; }
        .scan-body h2 { font-family: 'Orbitron'; margin: 0 0 10px 0; font-size: 24px; text-shadow: 0 0 10px var(--primary); }

        /* --- INITIALIZE BUTTON --- */
        #init-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; background: transparent; color: var(--primary);
            border: 2px solid var(--primary); font-family: 'Orbitron';
            font-size: 20px; cursor: pointer; z-index: 100;
            box-shadow: 0 0 20px var(--primary), inset 0 0 20px var(--primary);
            text-shadow: 0 0 5px var(--primary);
            transition: 0.3s;
        }
        #init-btn:hover { background: var(--primary); color: #000; }

        @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.3); opacity: 1; } }

    </style>
</head>
<body>

    <!-- VIDEO FEED -->
    <img id="video-layer" src="{{ url_for('video_feed') }}" onerror="this.src='https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExc2ZqZ2ZqZ2Zq/3o7qE1YN7aQSOeHcyY/giphy.gif'">

    <!-- HUD OVERLAY -->
    <div class="hud-overlay">
        <!-- Corners -->
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>

        <!-- Top Info -->
        <div class="header-bar">
            <div class="header-item" id="clock">00:00:00</div>
            <div class="header-item">SYS: ONLINE</div>
            <div class="header-item">NET: SECURE</div>
            <div class="header-item">LOC: STARK TOWER</div>
        </div>

        <!-- Left Stats -->
        <div class="left-col">
            <div class="stat-box">
                <div class="stat-label">CPU INTEGRITY</div>
                <div class="stat-bar"><div class="stat-fill" id="cpu-bar"></div></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">MEMORY BUFFER</div>
                <div class="stat-bar"><div class="stat-fill" id="mem-bar"></div></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">POWER CELL</div>
                <div class="stat-bar"><div class="stat-fill" style="width: 88%"></div></div>
            </div>
            <div style="margin-top:20px; font-size: 8px; color: var(--secondary)">
                // PROTOCOL 19<br>
                // MK-85 ACTIVE<br>
                // UPLINK ESTABLISHED
            </div>
        </div>

        <!-- Right Logs -->
        <div class="right-col" id="log-container"></div>

        <!-- Result Popup -->
        <div class="scan-window" id="result-box">
            <div class="scan-header">
                <span>ANALYSIS</span>
                <span>ID: #9932</span>
            </div>
            <div class="scan-body">
                <h2 id="result-title">TARGET LOCKED</h2>
                <div style="color: var(--secondary); font-size: 12px; margin-bottom: 10px;">PROBABILITY MATRIX COMPUTED</div>
                <div style="font-size: 30px; font-weight: bold; color: #fff;" id="result-conf">98.4%</div>
            </div>
        </div>

        <!-- Bottom Voice UI -->
        <div class="voice-hud">
            <div class="arc-reactor" id="reactor">
                <div class="ring r1"></div>
                <div class="ring r2"></div>
                <div class="ring r3"></div>
            </div>
            <div id="subtitle">WAITING FOR COMMAND...</div>
        </div>
    </div>

    <button id="init-btn" onclick="initSystem()">INITIALIZE SYSTEM</button>

    <script>
        const synth = window.speechSynthesis;
        let recognition;
        let voices = [];

        // --- UI CLOCK & ANIMATIONS ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', {hour12: false});
        }
        setInterval(updateClock, 1000);

        function updateStats() {
            document.getElementById('cpu-bar').style.width = Math.floor(Math.random() * 40 + 60) + "%";
            document.getElementById('mem-bar').style.width = Math.floor(Math.random() * 30 + 50) + "%";
        }
        setInterval(updateStats, 800);

        function addLog() {
            const logs = document.getElementById('log-container');
            const hex = Math.random().toString(16).substr(2, 8).toUpperCase();
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="highlight">0x${hex}</span> :: PROCESS_${Math.floor(Math.random()*99)}`;
            logs.insertBefore(div, logs.firstChild);
            if(logs.children.length > 20) logs.removeChild(logs.lastChild);
        }
        setInterval(addLog, 150);

        // --- VOICE CORE ---

        window.speechSynthesis.onvoiceschanged = () => { voices = window.speechSynthesis.getVoices(); };

        function initSystem() {
            const btn = document.getElementById('init-btn');
            btn.style.transform = "translate(-50%, -50%) scale(0)";
            setTimeout(() => btn.style.display = 'none', 300);
            
            speak("Interface initialized. FRIDAY online.");
            startListening();
        }

        function speak(text) {
            if(synth.speaking) synth.cancel();
            
            document.getElementById('subtitle').innerText = text.toUpperCase();
            
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 1.1; 
            u.pitch = 1.0; 
            const desired = voices.find(v => v.name.includes("Google US English") || v.name.includes("Zira") || v.name.includes("Female"));
            if(desired) u.voice = desired;

            const reactor = document.getElementById('reactor');
            
            u.onstart = () => { reactor.classList.add('speaking'); };
            u.onend = () => { 
                reactor.classList.remove('speaking'); 
                document.getElementById('subtitle').innerText = "LISTENING...";
            };
            
            synth.speak(u);
        }

        function startListening() {
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SpeechRec) {
                alert("Speech API not supported in this browser. Please use Chrome.");
                return;
            }
            recognition = new SpeechRec();
            recognition.continuous = true;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            
            recognition.onresult = (e) => {
                const txt = e.results[e.results.length-1][0].transcript.toLowerCase();
                console.log("CMD:", txt);
                document.getElementById('subtitle').innerText = "> " + txt;
                sendCommand(txt);
            };

            // FIX: Auto-restart listening if it stops
            recognition.onend = () => {
                console.log("Recognition ended. Restarting...");
                recognition.start();
            };
            
            recognition.onerror = (e) => { console.log("Recog Error", e); };
            recognition.start();
        }

        function sendCommand(cmd) {
            document.getElementById('log-container').innerHTML = `<div class='log-entry highlight'>PROCESSING: ${cmd}</div>` + document.getElementById('log-container').innerHTML;

            fetch('/api/command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({command: cmd})
            })
            .then(r => r.json())
            .then(data => {
                if(data.speech) speak(data.speech);
                if (data.action === "open_window") window.open(data.url, "_blank", "width=1200,height=800");
                if (data.action === "scan") triggerScan();
            })
            .catch(err => {
                console.error(err);
                if(cmd.includes("scan")) triggerScan();
            });
        }

        function triggerScan() {
            const win = document.getElementById('result-box');
            win.classList.add('active');
            
            document.getElementById('result-title').innerText = "SCANNING...";
            document.getElementById('result-conf').innerText = "CALCULATING";

            fetch('/api/analyze', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                updateScanUI(data.ui_text, data.confidence, data.speech_text);
            })
            .catch(() => {
                setTimeout(() => {
                    updateScanUI("UNKNOWN OBJECT", "88.5%", "Object analysis complete.");
                }, 2000);
            });

            function updateScanUI(title, conf, speech) {
                document.getElementById('result-title').innerText = title;
                document.getElementById('result-conf').innerText = conf;
                speak(speech);
                setTimeout(() => win.classList.remove('active'), 5000);
            }
        }
    </script>
</body>
</html>